name: Build BTHome Sensor

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: nordicplayground/nrfconnect-sdk:v2.5-branch

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: my-app

      - name: Build Firmware
        working-directory: my-app
        env:
          # We explicitly tell CMake where Zephyr is (pre-installed in this image)
          # The path /opt/ncs/zephyr is standard for the v2.5 image
          ZEPHYR_BASE: /opt/ncs/zephyr
        run: |
          echo "=== DEBUG: Checking Environment ==="
          ls -F /opt/ncs/ || echo "SDK not found at /opt/ncs"
          
          echo "=== STEP 1: Installing West ==="
          # We install west manually to guarantee it exists in the path
          pip3 install west
          
          echo "=== STEP 2: Building Firmware ==="
          # We build directly using the pre-installed SDK. 
          # -p always : Forces a clean build
          # -b nice_nano_v2 : The board name
          # . : The source directory (current folder)
          west build -p always -b nice_nano_v2 .

      - name: Archive Firmware
        uses: actions/upload-artifact@v4
        with:
          name: bthome_sensor_firmware
          path: my-app/build/zephyr/zephyr.uf2
