name: Build BTHome Sensor

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: nordicplayground/nrfconnect-sdk:v2.7-branch

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: my-app

      - name: Build Firmware
        working-directory: my-app
        # We manually install 'west' to ensure it is found in the path.
        # Then we initialize the workspace and build.
        run: |
          # 1. Force install west to fix "not found" error
          pip3 install west

          # 2. Initialize the workspace (links your code to the build system)
          west init -l .

          # 3. Fetch the Zephyr/Nordic dependencies
          # We use --narrow to speed up the download
          west update --narrow -o=--depth=1

          # 4. Export the CMake package so the build system finds Zephyr
          west zephyr-export

          # 5. Build for the SuperMini (nice_nano_v2)
          # The -p flag forces a pristine build (cleans old cache)
          west build -b nice_nano_v2 . -p

      - name: Archive Firmware
        uses: actions/upload-artifact@v4
        with:
          name: bthome_sensor_firmware
          path: my-app/build/zephyr/zephyr.uf2
